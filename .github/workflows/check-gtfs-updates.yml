name: Check TTC GTFS Updates

on:
  schedule:
    # Run every Sunday at 6 AM UTC (1 AM EST)
    - cron: '0 6 * * 0'
  workflow_dispatch: # Allow manual trigger

jobs:
  check-gtfs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Get current GTFS version
        id: current
        run: |
          # Extract version from stops-db.ts
          VERSION=$(grep "DATA_VERSION = " src/lib/data/stops-db.ts | sed "s/.*= '\(.*\)'.*/\1/")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Current GTFS version: $VERSION"

      - name: Download latest GTFS
        id: download
        run: |
          GTFS_URL="https://ckan0.cf.opendata.inter.prod-toronto.ca/dataset/7795b45e-e65a-4465-81fc-c36b9dfff169/resource/cfb6b2b8-6191-41e3-bda1-b175c51148cb/download/TTC%20Routes%20and%20Schedules%20Data.zip"
          
          mkdir -p scripts/gtfs
          
          # Download and get last-modified header
          curl -sL -o scripts/gtfs-download.zip \
            -w "%{http_code}" \
            -D scripts/gtfs-headers.txt \
            "$GTFS_URL"
          
          # Extract last-modified date from headers
          LAST_MODIFIED=$(grep -i "last-modified" scripts/gtfs-headers.txt | cut -d: -f2- | tr -d '\r' | xargs)
          echo "GTFS Last-Modified: $LAST_MODIFIED"
          
          # Convert to date format for comparison
          if [ -n "$LAST_MODIFIED" ]; then
            GTFS_DATE=$(date -d "$LAST_MODIFIED" +%Y-%m-%d 2>/dev/null || echo "unknown")
          else
            GTFS_DATE=$(date +%Y-%m-%d)
          fi
          echo "gtfs_date=$GTFS_DATE" >> $GITHUB_OUTPUT
          
          # Extract and check feed_info for version
          cd scripts
          unzip -o gtfs-download.zip -d gtfs
          
          if [ -f gtfs/feed_info.txt ]; then
            FEED_VERSION=$(tail -1 gtfs/feed_info.txt | cut -d',' -f2)
            echo "feed_version=$FEED_VERSION" >> $GITHUB_OUTPUT
            echo "Feed version from GTFS: $FEED_VERSION"
          fi
          
          # Get file checksum for comparison
          CHECKSUM=$(md5sum gtfs-download.zip | cut -d' ' -f1)
          echo "checksum=$CHECKSUM" >> $GITHUB_OUTPUT
          echo "GTFS file checksum: $CHECKSUM"

      - name: Compare versions
        id: compare
        run: |
          CURRENT="${{ steps.current.outputs.version }}"
          GTFS_DATE="${{ steps.download.outputs.gtfs_date }}"
          
          # Extract date from current version (format: YYYY-MM-DD-*)
          CURRENT_DATE=$(echo "$CURRENT" | grep -oP '^\d{4}-\d{2}-\d{2}' || echo "")
          
          echo "Current data date: $CURRENT_DATE"
          echo "Latest GTFS date: $GTFS_DATE"
          
          if [ "$GTFS_DATE" != "unknown" ] && [ -n "$CURRENT_DATE" ]; then
            # Compare dates
            if [[ "$GTFS_DATE" > "$CURRENT_DATE" ]]; then
              echo "needs_update=true" >> $GITHUB_OUTPUT
              echo "âš ï¸ New GTFS data available! ($GTFS_DATE > $CURRENT_DATE)"
            else
              echo "needs_update=false" >> $GITHUB_OUTPUT
              echo "âœ… GTFS data is up to date"
            fi
          else
            # Can't determine dates, check if checksum file exists
            echo "needs_update=unknown" >> $GITHUB_OUTPUT
            echo "âš ï¸ Could not determine GTFS update status"
          fi

      - name: Create issue if update needed
        if: steps.compare.outputs.needs_update == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const gtfsDate = '${{ steps.download.outputs.gtfs_date }}';
            const currentVersion = '${{ steps.current.outputs.version }}';
            const feedVersion = '${{ steps.download.outputs.feed_version }}' || 'N/A';
            
            // Check for existing open issues
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'gtfs-update'
            });
            
            if (existingIssues.data.length > 0) {
              console.log('Issue already exists, skipping creation');
              return;
            }
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸšŒ TTC GTFS Update Available (${gtfsDate})`,
              labels: ['gtfs-update', 'automated'],
              body: `## New TTC GTFS Data Available
            
            **Current Version:** \`${currentVersion}\`
            **New GTFS Date:** \`${gtfsDate}\`
            **Feed Version:** \`${feedVersion}\`
            
            ### Steps to Update
            
            1. Download latest GTFS:
               \`\`\`bash
               npx ts-node scripts/download-gtfs.ts
               \`\`\`
            
            2. Process schedule data:
               \`\`\`bash
               npx ts-node scripts/process-gtfs-schedules.ts
               \`\`\`
            
            3. Update DATA_VERSION in \`src/lib/data/stops-db.ts\`:
               \`\`\`typescript
               const DATA_VERSION = '${gtfsDate}-gtfs-update';
               \`\`\`
            
            4. Test locally and deploy
            
            ---
            *This issue was automatically created by the GTFS update check workflow.*
            `
            });
            
            console.log('Created GTFS update issue');

      - name: Summary
        run: |
          echo "## GTFS Update Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Current Version | \`${{ steps.current.outputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Latest GTFS Date | \`${{ steps.download.outputs.gtfs_date }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Feed Version | \`${{ steps.download.outputs.feed_version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Needs Update | \`${{ steps.compare.outputs.needs_update }}\` |" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup
        run: |
          rm -f scripts/gtfs-download.zip scripts/gtfs-headers.txt
          rm -rf scripts/gtfs
