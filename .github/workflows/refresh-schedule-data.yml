name: Refresh TTC Schedule Data (GTFS)

on:
  schedule:
    # Run monthly on the 1st at 4:00 AM UTC (11:00 PM EST previous day)
    # TTC publishes GTFS updates approximately every 6 weeks
    - cron: "0 4 1 * *"
  workflow_dispatch:
    # Allow manual trigger from GitHub Actions UI
    inputs:
      force_update:
        description: "Force update even if no changes detected"
        required: false
        type: boolean
        default: false

jobs:
  refresh-schedules:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: version-b
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Download latest GTFS data
        run: npx tsx scripts/download-gtfs.ts

      - name: Process GTFS schedules
        run: npx tsx scripts/process-gtfs-schedules.ts

      - name: Check for changes
        id: changes
        run: |
          git diff --name-only > changed_files.txt
          if [ -s changed_files.txt ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changed files:"
            cat changed_files.txt
            # Count stops in schedule file
            STOP_COUNT=$(jq 'keys | length' static/data/ttc-schedules.json)
            echo "stop_count=$STOP_COUNT" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true' || github.event.inputs.force_update == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: refresh TTC schedule data from GTFS"
          title: "ðŸ“… Monthly TTC Schedule Data Refresh"
          body: |
            ## Automated Schedule Data Refresh

            This PR was automatically created by the monthly schedule data refresh workflow.

            ### Data Source
            - **Source:** [Toronto Open Data - TTC Routes and Schedules](https://open.toronto.ca/dataset/ttc-routes-and-schedules/)
            - **Format:** GTFS (General Transit Feed Specification)
            - **TTC Update Frequency:** Approximately every 6 weeks

            ### Changes
            The following files were updated from the latest GTFS data:
            - `static/data/ttc-schedules.json` (~${{ steps.changes.outputs.stop_count }} stops)

            ### What This Data Is Used For
            The schedule data provides **fallback departure times** when real-time GPS data isn't available:
            - First AM departure per route per stop
            - First PM departure (after 3PM) for express routes
            - Weekend schedules (Saturday/Sunday)

            ### Review Checklist
            - [ ] Verify stop count is similar to before (~9,270 stops)
            - [ ] Spot-check a few routes for reasonable departure times
            - [ ] Check file size is reasonable (should be ~2-3 MB)

            ### Testing
            After merging, verify on https://version-b.ttc-alerts-svelte.pages.dev/routes that:
            - Route schedules display correctly
            - Express routes show PM departure times
            - Fallback times appear when no real-time data is available

            ---
            *This PR was auto-generated by GitHub Actions*
          branch: chore/refresh-schedule-data
          delete-branch: true
          labels: |
            automated
            data-refresh
            gtfs
