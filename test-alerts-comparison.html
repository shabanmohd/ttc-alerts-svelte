<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TTC Alerts Comparison - Bluesky vs Live API</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0f0f0f;
      color: #e0e0e0;
      padding: 16px;
      min-height: 100vh;
    }

    h1 {
      text-align: center;
      margin-bottom: 8px;
      color: #fff;
      font-size: 1.5rem;
    }

    .controls {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #2563eb;
      color: white;
    }

    .btn-primary:hover {
      background: #1d4ed8;
    }

    .btn-danger {
      background: #dc2626;
      color: white;
    }

    .btn-danger:hover {
      background: #b91c1c;
    }

    .btn-secondary {
      background: #374151;
      color: white;
    }

    .btn-secondary:hover {
      background: #4b5563;
    }

    .status-bar {
      display: flex;
      justify-content: center;
      gap: 24px;
      margin-bottom: 16px;
      font-size: 12px;
      color: #9ca3af;
    }

    .status-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #6b7280;
    }

    .status-dot.active {
      background: #22c55e;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      max-width: 1600px;
      margin: 0 auto;
    }

    @media (max-width: 900px) {
      .container {
        grid-template-columns: 1fr;
      }
    }

    .panel {
      background: #1a1a1a;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid #333;
    }

    .panel-header {
      padding: 12px 16px;
      font-weight: 700;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .panel-header.bluesky {
      background: linear-gradient(135deg, #0085ff, #0066cc);
      color: white;
    }

    .panel-header.ttc {
      background: linear-gradient(135deg, #c8102e, #a00d24);
      color: white;
    }

    .panel-count {
      background: rgba(255,255,255,0.2);
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
    }

    .panel-content {
      height: 70vh;
      overflow-y: auto;
      padding: 8px;
    }

    .alert-item {
      background: #252525;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      border-left: 4px solid #6b7280;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .alert-item.new {
      border-left-color: #22c55e;
      background: #1a2e1a;
    }

    .alert-item.disruption {
      border-left-color: #ef4444;
    }

    .alert-item.delay {
      border-left-color: #f59e0b;
    }

    .alert-item.planned {
      border-left-color: #3b82f6;
    }

    .alert-timestamp {
      font-size: 10px;
      color: #6b7280;
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
    }

    .alert-id {
      font-family: monospace;
      color: #9ca3af;
    }

    .alert-routes {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 6px;
    }

    .route-badge {
      background: #c8102e;
      color: white;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 700;
    }

    .route-badge.subway {
      background: #ffc524;
      color: black;
    }

    .route-badge.express {
      background: #00853f;
    }

    .alert-title {
      font-weight: 600;
      font-size: 13px;
      margin-bottom: 4px;
      color: #fff;
    }

    .alert-description {
      font-size: 12px;
      color: #9ca3af;
      line-height: 1.4;
    }

    .alert-effect {
      margin-top: 6px;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 4px;
      display: inline-block;
    }

    .effect-disruption {
      background: #450a0a;
      color: #fca5a5;
    }

    .effect-delay {
      background: #451a03;
      color: #fcd34d;
    }

    .effect-planned {
      background: #1e3a5f;
      color: #93c5fd;
    }

    .effect-detour {
      background: #431407;
      color: #fdba74;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: #6b7280;
    }

    .log-panel {
      margin-top: 16px;
      background: #1a1a1a;
      border-radius: 12px;
      padding: 12px;
      border: 1px solid #333;
    }

    .log-header {
      font-weight: 600;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
    }

    .log-content {
      font-family: monospace;
      font-size: 11px;
      max-height: 150px;
      overflow-y: auto;
      color: #9ca3af;
    }

    .log-entry {
      padding: 2px 0;
      border-bottom: 1px solid #333;
    }

    .log-entry.error {
      color: #f87171;
    }

    .log-entry.success {
      color: #4ade80;
    }
  </style>
</head>
<body>
  <h1>üöá TTC Alerts Comparison</h1>
  <p style="text-align: center; color: #6b7280; margin-bottom: 16px; font-size: 12px;">
    Bluesky @ttcservicealerts vs TTC Service Alerts API
  </p>

  <div class="controls">
    <button class="btn-primary" onclick="startPolling()">‚ñ∂ Start Polling</button>
    <button class="btn-danger" onclick="stopPolling()">‚èπ Stop</button>
    <button class="btn-secondary" onclick="fetchOnce()">üîÑ Fetch Once</button>
    <button class="btn-secondary" onclick="clearAll()">üóëÔ∏è Clear All</button>
    <select id="interval" style="padding: 8px 12px; border-radius: 6px; background: #374151; color: white; border: none;">
      <option value="30000">30 seconds</option>
      <option value="60000" selected>1 minute</option>
      <option value="120000">2 minutes</option>
      <option value="300000">5 minutes</option>
    </select>
  </div>

  <div class="status-bar">
    <div class="status-item">
      <span class="status-dot" id="bluesky-status"></span>
      <span>Bluesky: <span id="bluesky-last">Never</span></span>
    </div>
    <div class="status-item">
      <span class="status-dot" id="ttc-status"></span>
      <span>TTC API: <span id="ttc-last">Never</span></span>
    </div>
  </div>

  <div class="container">
    <div class="panel">
      <div class="panel-header bluesky">
        <span>ü¶ã Bluesky @ttcservicealerts</span>
        <span class="panel-count" id="bluesky-count">0</span>
      </div>
      <div class="panel-content" id="bluesky-alerts">
        <div class="empty-state">Click "Start Polling" or "Fetch Once" to load alerts</div>
      </div>
    </div>

    <div class="panel">
      <div class="panel-header ttc">
        <span>üöå TTC Service Alerts API</span>
        <span class="panel-count" id="ttc-count">0</span>
      </div>
      <div class="panel-content" id="ttc-alerts">
        <div class="empty-state">Click "Start Polling" or "Fetch Once" to load alerts</div>
      </div>
    </div>
  </div>

  <div class="log-panel">
    <div class="log-header">
      <span>üìã Activity Log</span>
      <button onclick="document.getElementById('log-content').innerHTML=''" style="font-size: 11px; padding: 2px 8px;">Clear</button>
    </div>
    <div class="log-content" id="log-content"></div>
  </div>

  <script>
    // Configuration
    const BLUESKY_API = 'https://public.api.bsky.app/xrpc/app.bsky.feed.getAuthorFeed';
    const BLUESKY_ACTOR = 'ttcalerts.bsky.social'; // Active TTC alerts account
    const TTC_API = 'https://alerts.ttc.ca/api/alerts/live-alerts';
    
    // CORS proxy for local testing (bypasses browser CORS restrictions)
    const CORS_PROXY = 'https://corsproxy.io/?';

    // State
    let pollingInterval = null;
    let blueskyAlerts = new Map(); // id -> alert
    let ttcAlerts = new Map(); // id -> alert
    let blueskyCount = 0;
    let ttcCount = 0;

    // Logging
    function log(message, type = 'info') {
      const logEl = document.getElementById('log-content');
      const time = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = `[${time}] ${message}`;
      logEl.insertBefore(entry, logEl.firstChild);
    }

    // Format timestamp
    function formatTime(date) {
      return date.toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit' 
      });
    }

    // Determine alert type from content
    function getAlertType(text) {
      const lower = text.toLowerCase();
      if (lower.includes('disruption') || lower.includes('no service') || lower.includes('suspended')) {
        return 'disruption';
      }
      if (lower.includes('delay')) {
        return 'delay';
      }
      if (lower.includes('planned') || lower.includes('closure') || lower.includes('scheduled')) {
        return 'planned';
      }
      if (lower.includes('detour') || lower.includes('diversion')) {
        return 'detour';
      }
      return '';
    }

    // Extract routes from text
    function extractRoutes(text) {
      const routes = [];
      
      // Subway lines
      const subwayMatch = text.match(/Line [1-6]/gi);
      if (subwayMatch) {
        subwayMatch.forEach(m => routes.push({ name: m, type: 'subway' }));
      }
      
      // Route numbers (3 digits)
      const routeMatch = text.match(/\b(\d{1,3})\s*(bus|streetcar)?/gi);
      if (routeMatch) {
        routeMatch.forEach(m => {
          const num = m.match(/\d+/)[0];
          if (num.length <= 3 && parseInt(num) > 0 && parseInt(num) < 600) {
            const type = parseInt(num) >= 900 ? 'express' : 'regular';
            routes.push({ name: num, type });
          }
        });
      }
      
      return routes.slice(0, 5); // Max 5 routes
    }

    // Create alert HTML
    function createAlertHTML(alert, source, isNew = false) {
      const routes = alert.routes || extractRoutes(alert.title || alert.text || '');
      const type = alert.type || getAlertType(alert.title || alert.text || '');
      
      const routeBadges = routes.map(r => 
        `<span class="route-badge ${r.type}">${r.name}</span>`
      ).join('');

      const effectClass = type ? `effect-${type}` : '';
      const effectBadge = type ? `<span class="alert-effect ${effectClass}">${type.toUpperCase()}</span>` : '';

      return `
        <div class="alert-item ${type} ${isNew ? 'new' : ''}">
          <div class="alert-timestamp">
            <span>üì• ${formatTime(new Date())}</span>
            <span class="alert-id">${alert.id?.substring(0, 12) || 'N/A'}...</span>
          </div>
          ${routeBadges ? `<div class="alert-routes">${routeBadges}</div>` : ''}
          <div class="alert-title">${alert.title || 'Service Alert'}</div>
          <div class="alert-description">${alert.description || alert.text || ''}</div>
          ${effectBadge}
          ${alert.originalTime ? `<div style="font-size: 10px; color: #6b7280; margin-top: 4px;">Posted: ${alert.originalTime}</div>` : ''}
        </div>
      `;
    }

    // Fetch Bluesky alerts
    async function fetchBluesky() {
      try {
        const url = `${BLUESKY_API}?actor=${BLUESKY_ACTOR}&limit=30`;
        // Use CORS proxy for local file:// access
        const fetchUrl = window.location.protocol === 'file:' ? CORS_PROXY + encodeURIComponent(url) : url;
        const response = await fetch(fetchUrl);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        const container = document.getElementById('bluesky-alerts');
        
        let newCount = 0;
        
        if (data.feed && data.feed.length > 0) {
          // Remove empty state if present
          if (container.querySelector('.empty-state')) {
            container.innerHTML = '';
          }
          
          data.feed.forEach(item => {
            const post = item.post;
            const id = post.uri;
            
            if (!blueskyAlerts.has(id)) {
              const alert = {
                id: id,
                title: 'Bluesky Post',
                text: post.record?.text || '',
                originalTime: new Date(post.record?.createdAt).toLocaleString(),
                routes: extractRoutes(post.record?.text || ''),
                type: getAlertType(post.record?.text || '')
              };
              
              blueskyAlerts.set(id, alert);
              newCount++;
              
              const html = createAlertHTML(alert, 'bluesky', true);
              container.insertAdjacentHTML('afterbegin', html);
            }
          });
        }
        
        blueskyCount = blueskyAlerts.size;
        document.getElementById('bluesky-count').textContent = blueskyCount;
        document.getElementById('bluesky-last').textContent = formatTime(new Date());
        document.getElementById('bluesky-status').classList.add('active');
        
        log(`Bluesky: Fetched ${data.feed?.length || 0} posts, ${newCount} new`, 'success');
        
      } catch (error) {
        log(`Bluesky error: ${error.message}`, 'error');
        document.getElementById('bluesky-status').classList.remove('active');
      }
    }

    // Fetch TTC API alerts
    async function fetchTTC() {
      try {
        // Use CORS proxy for local file:// access
        const fetchUrl = window.location.protocol === 'file:' ? CORS_PROXY + encodeURIComponent(TTC_API) : TTC_API;
        const response = await fetch(fetchUrl);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        const container = document.getElementById('ttc-alerts');
        
        let newCount = 0;
        const alerts = data.routes || data.alerts || data;
        
        // Remove empty state if present
        if (container.querySelector('.empty-state') && alerts.length > 0) {
          container.innerHTML = '';
        }
        
        // Process alerts - handle nested structure
        const processAlerts = (items) => {
          if (!Array.isArray(items)) return;
          
          items.forEach(item => {
            // Could be route-level or direct alert
            const alertList = item.alerts || [item];
            
            alertList.forEach(alert => {
              const id = alert.id || alert.alert_id || `ttc-${Date.now()}-${Math.random()}`;
              
              if (!ttcAlerts.has(id)) {
                const processedAlert = {
                  id: id,
                  title: alert.headerText || alert.header_text || alert.title || item.name || 'TTC Alert',
                  description: alert.descriptionText || alert.description_text || alert.description || '',
                  routes: (alert.affectedRoutes || alert.affected_routes || [item.name]).filter(Boolean).map(r => ({
                    name: r,
                    type: r.includes('Line') ? 'subway' : (parseInt(r) >= 900 ? 'express' : 'regular')
                  })),
                  type: getAlertType(alert.effect || alert.headerText || alert.header_text || ''),
                  originalTime: alert.activePeriod?.[0]?.start 
                    ? new Date(alert.activePeriod[0].start * 1000).toLocaleString()
                    : null
                };
                
                ttcAlerts.set(id, processedAlert);
                newCount++;
                
                const html = createAlertHTML(processedAlert, 'ttc', true);
                container.insertAdjacentHTML('afterbegin', html);
              }
            });
          });
        };
        
        processAlerts(alerts);
        
        ttcCount = ttcAlerts.size;
        document.getElementById('ttc-count').textContent = ttcCount;
        document.getElementById('ttc-last').textContent = formatTime(new Date());
        document.getElementById('ttc-status').classList.add('active');
        
        log(`TTC API: Fetched ${alerts.length || 0} items, ${newCount} new`, 'success');
        
      } catch (error) {
        log(`TTC API error: ${error.message}`, 'error');
        document.getElementById('ttc-status').classList.remove('active');
      }
    }

    // Fetch both sources
    async function fetchOnce() {
      log('Fetching from both sources...');
      await Promise.all([fetchBluesky(), fetchTTC()]);
    }

    // Start polling
    function startPolling() {
      if (pollingInterval) {
        log('Polling already running');
        return;
      }
      
      const interval = parseInt(document.getElementById('interval').value);
      log(`Starting polling every ${interval / 1000} seconds`);
      
      fetchOnce();
      pollingInterval = setInterval(fetchOnce, interval);
    }

    // Stop polling
    function stopPolling() {
      if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
        log('Polling stopped');
        document.getElementById('bluesky-status').classList.remove('active');
        document.getElementById('ttc-status').classList.remove('active');
      }
    }

    // Clear all
    function clearAll() {
      blueskyAlerts.clear();
      ttcAlerts.clear();
      blueskyCount = 0;
      ttcCount = 0;
      
      document.getElementById('bluesky-alerts').innerHTML = '<div class="empty-state">Cleared</div>';
      document.getElementById('ttc-alerts').innerHTML = '<div class="empty-state">Cleared</div>';
      document.getElementById('bluesky-count').textContent = '0';
      document.getElementById('ttc-count').textContent = '0';
      
      log('All alerts cleared');
    }

    // Initial log
    log('Page loaded. Click "Start Polling" to begin fetching alerts.');
  </script>
</body>
</html>
