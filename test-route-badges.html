<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live TTC Alerts - Route Badge Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* TTC Theme Colors */
        :root {
            --ttc-red: #DA291C;
            --ttc-gold: #FFD700;
            --ttc-subway-yellow: #FFCC00;
            --ttc-subway-green: #00A859;
            --ttc-bus-blue: #0072CE;
            --ttc-streetcar-red: #DA291C;
        }
        
        .route-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.125rem 0.5rem;
            border-radius: 0.375rem;
            font-weight: 600;
            font-size: 0.75rem;
            min-width: 2.5rem;
        }
        
        /* Subway Lines */
        .route-line-1 { background-color: #FFCC00; color: #000; }
        .route-line-2 { background-color: #00A859; color: #fff; }
        .route-line-3 { background-color: #0072CE; color: #fff; }
        .route-line-4 { background-color: #A020F0; color: #fff; }
        
        /* Streetcar routes (500-514) */
        .route-streetcar { background-color: #DA291C; color: #fff; }
        
        /* Bus routes */
        .route-bus { background-color: #0072CE; color: #fff; }
        
        /* Night routes (300-399) */
        .route-night { background-color: #1F2937; color: #fff; }
        
        /* Express routes (900+) */
        .route-express { background-color: #059669; color: #fff; }

        /* Category badges */
        .category-SERVICE_DISRUPTION { background-color: #EF4444; color: #fff; }
        .category-SERVICE_RESUMED { background-color: #22C55E; color: #fff; }
        .category-DELAY { background-color: #F59E0B; color: #000; }
        .category-DIVERSION { background-color: #8B5CF6; color: #fff; }
        .category-SHUTTLE { background-color: hsl(85 70% 90%); color: hsl(85 70% 25%); }
        .category-PLANNED_CLOSURE { background-color: #6B7280; color: #fff; }
        .category-OTHER { background-color: #374151; color: #fff; }
        
        .loading-spinner {
            border: 3px solid #374151;
            border-top: 3px solid #DA291C;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white p-6">
    <div class="max-w-3xl mx-auto">
        <h1 class="text-2xl font-bold mb-2 text-red-500">üö® Live TTC Alerts</h1>
        <p class="text-gray-400 text-sm mb-6">Fetched from Bluesky API with categorization & threading</p>
        
        <!-- Stats -->
        <div id="stats" class="grid grid-cols-3 gap-4 mb-6">
            <div class="bg-gray-800 rounded-lg p-3 text-center">
                <div id="total-count" class="text-2xl font-bold text-blue-400">-</div>
                <div class="text-xs text-gray-500">Total Posts</div>
            </div>
            <div class="bg-gray-800 rounded-lg p-3 text-center">
                <div id="thread-count" class="text-2xl font-bold text-purple-400">-</div>
                <div class="text-xs text-gray-500">Threads</div>
            </div>
            <div class="bg-gray-800 rounded-lg p-3 text-center">
                <div id="route-count" class="text-2xl font-bold text-green-400">-</div>
                <div class="text-xs text-gray-500">Routes Affected</div>
            </div>
        </div>
        
        <!-- Loading state -->
        <div id="loading" class="flex items-center gap-3 justify-center py-8">
            <div class="loading-spinner"></div>
            <span class="text-gray-400">Fetching alerts from Bluesky...</span>
        </div>
        
        <!-- Alerts container -->
        <div id="alerts-container" class="space-y-4 hidden"></div>
        
        <!-- Debug panel -->
        <details class="mt-8 bg-gray-800 rounded-lg">
            <summary class="cursor-pointer p-4 text-blue-400 font-medium">üîß Debug: Raw Data & Logic</summary>
            <div class="p-4 pt-0 space-y-4">
                <div>
                    <h3 class="text-sm font-semibold text-gray-400 mb-2">extractRoutes() Logic</h3>
                    <pre id="extract-routes-code" class="text-xs bg-gray-900 p-3 rounded overflow-x-auto text-gray-300"></pre>
                </div>
                <div>
                    <h3 class="text-sm font-semibold text-gray-400 mb-2">categorizeAlert() Logic</h3>
                    <pre id="categorize-code" class="text-xs bg-gray-900 p-3 rounded overflow-x-auto text-gray-300"></pre>
                </div>
                <div>
                    <h3 class="text-sm font-semibold text-gray-400 mb-2">Raw API Response</h3>
                    <pre id="raw-data" class="text-xs bg-gray-900 p-3 rounded overflow-x-auto text-gray-300 max-h-96"></pre>
                </div>
            </div>
        </details>
    </div>

    <script>
        // ============================================
        // ALERT CATEGORIES (from poll-alerts/index.ts)
        // ============================================
        const ALERT_CATEGORIES = {
            SERVICE_DISRUPTION: {
                keywords: ['no service', 'suspended', 'closed', 'not stopping', 'bypassing'],
                priority: 1
            },
            SERVICE_RESUMED: {
                keywords: ['regular service', 'resumed', 'restored', 'back to normal', 'now stopping'],
                priority: 2
            },
            DELAY: {
                keywords: ['delay', 'delayed', 'slower', 'longer wait'],
                priority: 3
            },
            DIVERSION: {
                keywords: ['diverting', 'detour', 'alternate route', 'diversion'],
                priority: 4
            },
            SHUTTLE: {
                keywords: ['shuttle', 'buses replacing'],
                priority: 4
            },
            PLANNED_CLOSURE: {
                keywords: ['planned', 'scheduled', 'maintenance', 'this weekend'],
                priority: 5
            }
        };

        // ============================================
        // EXTRACT ROUTES (from poll-alerts/index.ts)
        // ============================================
        function extractRoutes(text) {
            const routes = [];
            
            // Match subway lines first: Line 1, Line 2, Line 4
            const lineMatch = text.match(/Line\s*(\d+)/gi);
            if (lineMatch) {
                lineMatch.forEach(m => {
                    routes.push(m); // Keep "Line 1" format
                });
            }
            
            // Match route numbers with letter suffix variants: "37A", "37B", "123C", "123D"
            const routeWithSuffixMatch = text.match(/\b(\d{1,3}[A-Z])\b/g);
            if (routeWithSuffixMatch) {
                routeWithSuffixMatch.forEach(m => {
                    routes.push(m);
                });
            }
            
            // Match numbered routes with optional name: "306 Carlton", "504 King", etc.
            const routeWithNameMatch = text.match(/\b(\d{1,3})\s+([A-Z][a-z]+(?:\s+[A-Z][a-z]+)?)/g);
            if (routeWithNameMatch) {
                routeWithNameMatch.forEach(m => {
                    routes.push(m);
                });
            }
            
            // Match standalone route numbers
            const standaloneMatch = text.match(/\b(\d{1,3})(?=[,:\s]|$)/g);
            if (standaloneMatch) {
                standaloneMatch.forEach(num => {
                    if (parseInt(num) < 1000 && !routes.some(r => r === num || r.startsWith(num + ' '))) {
                        routes.push(num);
                    }
                });
            }
            
            return [...new Set(routes)];
        }

        // ============================================
        // CATEGORIZE ALERT (from poll-alerts/index.ts)
        // ============================================
        function categorizeAlert(text) {
            const lowerText = text.toLowerCase();
            
            for (const [category, config] of Object.entries(ALERT_CATEGORIES)) {
                if (config.keywords.some(kw => lowerText.includes(kw))) {
                    return { category, priority: config.priority };
                }
            }
            
            return { category: 'OTHER', priority: 10 };
        }

        // ============================================
        // GET DISPLAY ROUTES (from AlertCard.svelte)
        // ============================================
        function getDisplayRoutes(affected_routes) {
            const routeFamilies = new Map();
            
            for (const route of affected_routes) {
                const baseMatch = route.match(/^(\d+)/);
                if (baseMatch) {
                    const base = baseMatch[1];
                    if (!routeFamilies.has(base)) {
                        routeFamilies.set(base, []);
                    }
                    routeFamilies.get(base).push(route);
                } else if (route.startsWith('Line')) {
                    routeFamilies.set(route, [route]);
                }
            }
            
            return Array.from(routeFamilies.keys()).map(base => {
                if (base.startsWith('Line')) return base;
                const variants = routeFamilies.get(base);
                if (variants.length === 1 && /^\d+[A-Z]$/.test(variants[0])) {
                    return variants[0];
                }
                return base;
            });
        }

        // ============================================
        // GET ROUTE BADGE CLASS
        // ============================================
        function getRouteBadgeClass(route) {
            if (route.startsWith('Line 1')) return 'route-line-1';
            if (route.startsWith('Line 2')) return 'route-line-2';
            if (route.startsWith('Line 3')) return 'route-line-3';
            if (route.startsWith('Line 4')) return 'route-line-4';
            
            const numMatch = route.match(/^(\d+)/);
            if (numMatch) {
                const num = parseInt(numMatch[1]);
                if (num >= 500 && num <= 514) return 'route-streetcar';
                if (num >= 300 && num <= 399) return 'route-night';
                if (num >= 900) return 'route-express';
            }
            return 'route-bus';
        }

        // ============================================
        // THREADING LOGIC
        // ============================================
        function buildThreads(posts) {
            const threads = new Map(); // root URI -> array of posts
            const postMap = new Map(); // URI -> post
            
            // Build post map
            posts.forEach(item => {
                postMap.set(item.post.uri, item);
            });
            
            // Group into threads
            posts.forEach(item => {
                const post = item.post;
                const reply = item.reply;
                
                if (reply && reply.root) {
                    // This is a reply - add to existing thread
                    const rootUri = reply.root.uri;
                    if (!threads.has(rootUri)) {
                        threads.set(rootUri, []);
                    }
                    threads.get(rootUri).push(item);
                } else {
                    // This is a root post
                    if (!threads.has(post.uri)) {
                        threads.set(post.uri, []);
                    }
                    // Add root post itself
                    threads.get(post.uri).unshift(item);
                }
            });
            
            return threads;
        }

        // ============================================
        // RENDER ALERT CARD
        // ============================================
        function renderAlertCard(item, isThreadRoot = false, threadReplies = []) {
            const post = item.post;
            const text = post.record.text;
            const { category, priority } = categorizeAlert(text);
            const routes = extractRoutes(text);
            const displayRoutes = getDisplayRoutes(routes);
            const createdAt = new Date(post.record.createdAt).toLocaleString();
            
            const badges = displayRoutes.map(route => 
                \`<span class="route-badge \${getRouteBadgeClass(route)}">\${route}</span>\`
            ).join('');
            
            const threadRepliesHtml = threadReplies.length > 0 ? \`
                <div class="mt-3 border-l-2 border-gray-600 pl-3 space-y-2">
                    \${threadReplies.map(reply => {
                        const replyText = reply.post.record.text;
                        const { category: replyCategory } = categorizeAlert(replyText);
                        const replyTime = new Date(reply.post.record.createdAt).toLocaleString();
                        return \`
                            <div class="text-sm">
                                <span class="text-xs px-2 py-0.5 rounded category-\${replyCategory}">\${replyCategory.replace('_', ' ')}</span>
                                <span class="text-gray-500 text-xs ml-2">\${replyTime}</span>
                                <p class="text-gray-300 mt-1">\${replyText}</p>
                            </div>
                        \`;
                    }).join('')}
                </div>
            \` : '';
            
            return \`
                <div class="bg-gray-800 rounded-lg p-4 \${isThreadRoot && threadReplies.length > 0 ? 'border-l-4 border-purple-500' : ''}">
                    <div class="flex items-center gap-2 mb-2 flex-wrap">
                        \${badges || '<span class="text-gray-500 text-xs">No routes detected</span>'}
                        <span class="text-xs px-2 py-0.5 rounded category-\${category}">\${category.replace('_', ' ')}</span>
                        \${threadReplies.length > 0 ? \`<span class="text-xs px-2 py-0.5 rounded bg-purple-900 text-purple-300">üßµ \${threadReplies.length + 1} posts</span>\` : ''}
                    </div>
                    <p class="text-sm text-gray-300">\${text}</p>
                    <div class="mt-2 flex justify-between items-start">
                        <div class="text-xs text-gray-500">
                            <div>üìç affected_routes: [\${routes.map(r => \`"\${r}"\`).join(', ')}]</div>
                            <div>üè∑Ô∏è display_routes: [\${displayRoutes.map(r => \`"\${r}"\`).join(', ')}]</div>
                        </div>
                        <span class="text-xs text-gray-600">\${createdAt}</span>
                    </div>
                    \${threadRepliesHtml}
                </div>
            \`;
        }

        // ============================================
        // MAIN: FETCH AND RENDER
        // ============================================
        async function fetchAndRender() {
            const loadingEl = document.getElementById('loading');
            const containerEl = document.getElementById('alerts-container');
            const rawDataEl = document.getElementById('raw-data');
            
            try {
                const response = await fetch('https://public.api.bsky.app/xrpc/app.bsky.feed.getAuthorFeed?actor=ttcalerts.bsky.social&limit=30');
                const data = await response.json();
                const posts = data.feed || [];
                
                // Update raw data display
                rawDataEl.textContent = JSON.stringify(data, null, 2);
                
                // Build threads
                const threads = buildThreads(posts);
                
                // Collect unique routes
                const allRoutes = new Set();
                posts.forEach(item => {
                    const routes = extractRoutes(item.post.record.text);
                    routes.forEach(r => {
                        const base = r.match(/^(\d+)/)?.[1] || r;
                        allRoutes.add(base);
                    });
                });
                
                // Update stats
                document.getElementById('total-count').textContent = posts.length;
                document.getElementById('thread-count').textContent = threads.size;
                document.getElementById('route-count').textContent = allRoutes.size;
                
                // Render alerts grouped by threads
                let html = '';
                const processedRoots = new Set();
                
                // First pass: render root posts with their replies
                posts.forEach(item => {
                    const post = item.post;
                    const reply = item.reply;
                    
                    // Only process root posts or standalone posts
                    if (!reply || !reply.root) {
                        const threadReplies = [];
                        
                        // Find all replies to this post
                        posts.forEach(otherItem => {
                            if (otherItem.reply && otherItem.reply.root && otherItem.reply.root.uri === post.uri) {
                                threadReplies.push(otherItem);
                            }
                        });
                        
                        // Sort replies by time
                        threadReplies.sort((a, b) => 
                            new Date(a.post.record.createdAt) - new Date(b.post.record.createdAt)
                        );
                        
                        html += renderAlertCard(item, true, threadReplies);
                        processedRoots.add(post.uri);
                    }
                });
                
                loadingEl.classList.add('hidden');
                containerEl.classList.remove('hidden');
                containerEl.innerHTML = html;
                
            } catch (error) {
                loadingEl.innerHTML = \`<span class="text-red-500">‚ùå Error: \${error.message}</span>\`;
                console.error('Fetch error:', error);
            }
        }

        // Show code in debug panel
        document.getElementById('extract-routes-code').textContent = extractRoutes.toString();
        document.getElementById('categorize-code').textContent = categorizeAlert.toString();
        
        // Fetch on load
        fetchAndRender();
    </script>
</body>
</html>
