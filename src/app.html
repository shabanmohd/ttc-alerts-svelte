<!doctype html>
<html lang="en" translate="yes">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    
    <!-- Google tag (gtag.js) - deferred loading to avoid render blocking -->
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      // Pre-initialize gtag before script loads
      gtag('js', new Date());
      gtag('config', 'G-SM5SYP463N');
      
      // Load GA script after page load to avoid render blocking
      if (typeof window !== 'undefined') {
        window.addEventListener('load', function() {
          setTimeout(function() {
            var script = document.createElement('script');
            script.src = 'https://www.googletagmanager.com/gtag/js?id=G-SM5SYP463N';
            script.async = true;
            document.head.appendChild(script);
          }, 100); // Small delay to ensure page is fully rendered
        });
      }
    </script>
    
    <!-- DNS Prefetch for faster resource loading -->
    <link rel="dns-prefetch" href="https://wmchvmegxcpyfjcuzqzk.supabase.co">
    <link rel="preconnect" href="https://wmchvmegxcpyfjcuzqzk.supabase.co" crossorigin>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#9B44C7" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="rideTO" />
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json" />
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png?v=11" />
    <link rel="apple-touch-icon" sizes="152x152" href="/icons/icon-152x152.png?v=11" />
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png?v=11" />
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png?v=11" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png?v=11" />
    <link rel="icon" type="image/png" href="/favicon.png?v=11" />
    
    <!-- Preload logo -->
    <link rel="preload" href="/LOGO.svg" as="image" type="image/svg+xml" />
    
    <!-- Self-hosted Lexend font (dyslexic-friendly) - eliminates Google Fonts requests -->
    <link rel="preload" href="/fonts/lexend-variable.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="stylesheet" href="/fonts/fonts.css">
    
    <!-- Blocking language script to set lang from saved preference -->
    <script>
      (function() {
        const savedLang = localStorage.getItem('ttc-language');
        if (savedLang && ['en', 'fr'].includes(savedLang)) {
          document.documentElement.lang = savedLang;
        }
      })();
    </script>
    
    <!-- iOS PWA safe area detection - runs early to prevent layout shift -->
    <script>
      (function() {
        // Detect iOS PWA standalone mode
        var isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                          (window.navigator && window.navigator.standalone === true);
        if (isStandalone) {
          document.documentElement.classList.add('ios-pwa');
          // Force safe area calculation by adding a temporary style
          // This primes the browser to calculate env() values
          var style = document.createElement('style');
          style.textContent = ':root { --primed-safe-area: env(safe-area-inset-bottom, 0px); }';
          document.head.appendChild(style);
        }
      })();
    </script>
    
    <!-- SEO -->
    <meta name="description" content="Track TTC service alerts, subway closures, elevator outages & delays in real-time. Free transit tracker for Toronto subway, bus & streetcar routes." />
    <meta name="keywords" content="TTC, Toronto, transit, alerts, subway, bus, streetcar, delays, service disruptions, real-time" />
    <meta name="author" content="rideTO" />
    
    <!-- Open Graph (defaults - pages override with SEO component) -->
    <meta property="og:title" content="rideTO - Live TTC Alerts & Transit Tracker" />
    <meta property="og:description" content="Track TTC service alerts, subway closures, elevator outages & delays in real-time. Free transit tracker for Toronto subway, bus & streetcar routes." />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://rideto.ca" />
    <!-- Primary OG image (1200x630 landscape) -->
    <meta property="og:image" content="https://rideto.ca/icons/og-image.jpg?v=11" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:image:alt" content="rideTO - Toronto Transit Alerts" />
    <!-- Secondary OG image (1200x1200 square for WhatsApp, Telegram, etc.) -->
    <meta property="og:image" content="https://rideto.ca/icons/og-image-square.jpg?v=11" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="1200" />
    <meta property="og:image:alt" content="rideTO - Toronto Transit Alerts" />
    <meta property="og:site_name" content="rideTO" />
    <meta property="og:locale" content="en_CA" />
    
    <!-- Twitter Card (defaults - pages override with SEO component) -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="rideTO - Live TTC Alerts & Transit Tracker" />
    <meta name="twitter:description" content="Track TTC service alerts, subway closures, elevator outages & delays in real-time." />
    <meta name="twitter:image" content="https://rideto.ca/icons/og-image.jpg?v=11" />
    
    <!-- JSON-LD Structured Data -->
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "rideTO",
        "alternateName": "TTC Service Alerts",
        "description": "Track TTC service alerts, subway closures, elevator outages & delays in real-time. Free transit tracker for Toronto subway, bus & streetcar routes.",
        "url": "https://rideto.ca",
        "applicationCategory": "UtilitiesApplication",
        "operatingSystem": "Web",
        "browserRequirements": "Requires JavaScript",
        "offers": {
          "@type": "Offer",
          "price": "0",
          "priceCurrency": "CAD"
        },
        "creator": {
          "@type": "Organization",
          "name": "rideTO"
        },
        "aggregateRating": {
          "@type": "AggregateRating",
          "ratingValue": "4.5",
          "ratingCount": "100"
        },
        "featureList": [
          "Real-time TTC service alerts",
          "Subway line status",
          "Bus and streetcar delays",
          "Station elevator and escalator alerts",
          "Route bookmarking",
          "Push notifications"
        ],
        "inLanguage": ["en", "fr"],
        "areaServed": {
          "@type": "City",
          "name": "Toronto",
          "containedInPlace": {
            "@type": "AdministrativeArea",
            "name": "Ontario"
          }
        }
      }
    </script>
    
    <!-- Blocking theme script to prevent flash -->
    <script>
      (function() {
        const stored = localStorage.getItem('ttc-theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        
        if (stored === 'dark' || (stored === 'system' && prefersDark) || (!stored && prefersDark)) {
          document.documentElement.classList.add('dark');
        }
      })();
    </script>
    
    %sveltekit.head%
  </head>
  <body data-sveltekit-preload-data="hover">
    <div style="display: contents">%sveltekit.body%</div>
    
    <!-- Handle stale module errors from deployment cache mismatch -->
    <script>
      window.addEventListener('error', (event) => {
        // Stale cache after deployment - module doesn't exist or CDN returns HTML
        const isStaleModuleError = event.message && (
          event.message.includes('Failed to fetch dynamically imported module') ||
          event.message.includes('is not a valid JavaScript MIME type')
        );
        if (isStaleModuleError) {
          console.log('ðŸ”„ Stale module detected, reloading...');
          window.location.reload();
        }
      });
    </script>
    
    <!-- Register Service Worker with Update Detection -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          // Register SW with updateViaCache: 'none' to bypass HTTP cache
          // This ensures browser always checks for SW updates
          // Version in filename to bypass CDN cache (sw-v4.0.js)
          navigator.serviceWorker.register('/sw-v4.0.js', {
            updateViaCache: 'none'
          })
            .then(registration => {
              console.log('[App] SW registered');
              
              // Check for updates immediately on page load
              registration.update().catch(() => {});
              
              // Check for updates every 30 seconds (more aggressive for iOS PWA)
              setInterval(() => {
                registration.update().catch(() => {});
              }, 30000);
              
              // Also check for updates when page becomes visible (iOS PWA optimization)
              document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') {
                  registration.update().catch(() => {});
                }
              });
              
              // Listen for new service worker installation
              registration.addEventListener('updatefound', () => {
                const newWorker = registration.installing;
                if (!newWorker) return;
                console.log('[App] New SW installing...');
                
                newWorker.addEventListener('statechange', () => {
                  console.log('[App] SW state:', newWorker.state);
                  // When new SW is installed and waiting
                  if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                    console.log('[App] New SW ready, dispatching update event');
                    // Dispatch custom event for Svelte components to listen to
                    window.dispatchEvent(new CustomEvent('sw-update-available'));
                  }
                });
              });
              
              // If there's already a waiting SW, notify immediately
              if (registration.waiting) {
                window.dispatchEvent(new CustomEvent('sw-update-available'));
              }
            })
            .catch(err => {
              console.log('[App] SW registration failed:', err);
            });
        });
        
        // Listen for SW taking control (after skipWaiting)
        // We only reload when the user explicitly requests it via toast
        // The toast handler in +layout.svelte will trigger the reload after sending SKIP_WAITING
        let refreshing = false;
        let userRequestedRefresh = false;
        
        // Expose function for layout to call when user clicks refresh
        window.__swRefreshRequested = () => {
          userRequestedRefresh = true;
        };
        
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          // Only auto-reload if user requested it (clicked toast button)
          // This prevents abrupt reloads when SW updates automatically
          if (!refreshing && userRequestedRefresh) {
            refreshing = true;
            console.log('[App] User requested refresh, reloading...');
            window.location.reload();
          } else {
            console.log('[App] SW changed but not reloading (waiting for user action)');
          }
        });
      }
    </script>
  </body>
</html>
